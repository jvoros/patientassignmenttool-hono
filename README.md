# Patient Assignment Tool v 1.0

## Tools

- `server/core`: contains the source from the patientassignmenttools-core library
- `server`: runs a [Hono](http://hono.dev) web server to serve the backend
- `client`: contains a Vue project for the frontend

## Configuration

Like any modern javascript project the tooling is complex.

### `package.json`

The usual npm stuff.

- The `core...` scripts just copy over the core files from the other project, to keep that self contained.
- The `dev...` scripts use the "concurrently" project to start the Vite dev server for the Vue frontend and the Hono server for the backend. Hot Module Reloading works with both.
- `dev:client` launches the Vite project server. `client` is necessary to tell Vite to look in the client folder for the project.
- the `launch` script runs the necessary build steps and starts the server to serve the compiled frontend project

### `jsconfig.json`

Required for shadcn-vue. I don't actually think what is in here matters.

### `tailwind.config.js`

For tailwind (duh). It has to be in the root of the project.

- `content` option tells tailwind which files to process
- `theme.extend` options are the theming variables for shadcn-vue. Shadcn-vue uses these variables to style components so changing these values changes the components.

### `components.json`

This is the config for the shadcn-vue CLI. This is important to get the files in the right spot. The documentation for the project is not great.

- `tailwind` options are pretty self explanatory. Except, _`cssVariables: true`_ is critical for the tailwind theming. If this is set to `true` shadcn-vue will use the tailwind variables described in the tailwind config to style components, so that those variables can be used for site-wide styling. If this is set to false, the components will have color options set specifically on each component.

- `aliases` is also poorly documented.
  - `components` and `utils` aliases are added to the components downloaded by shadcn-vue. Because you can put the components wherever you'd like, shadcn-vue CLI uses the `@` alias feature to locate the necessary files. The `@` alias is configured in `vite.config.js`. So these path names are relative to whatever you set in `vite.config.js`.
  - `ui` alias is relative to the root of the project, e.g. where this file is located, and tells shadcn-vue CLI which folder components should be downloaded into.

### `client/vite.config.js`

- Plugins include:
  - `vue` - self explanatory
  - `unplugin-vue-components` to auto-import Vue components. Must be told which `dirs` to look in for components.
- `root` tells Vite where to find `index.html`, the entry point for the Vue app and Vite. This is relative to project root.
- `envDir` tells Vite where to find `.env` files.
- `build` and `css` are self-explanatory.
- `server` does some magic.
  - `proxy` sets routes outside the Vite dev server and tells Vite where to look for those routes. This way we can run our frontend dev server with Vite and the backend server with Hono can run also.
  - his config says: for `/api/*` routes, go ask `localhost:3000`, which is the port where Hono is running.
  - Any Hono route not prefixed with `/api`, such as `/hello` will not be found by the Vite dev server. _This is important later_ because the Hono server is set to serve the built Vue project from `/dist` at the `/index.html` endpoint, but in development, that Hono endpoint is never available from the frontend.
- `alias` comes back into play. This is set for the shadcn-vue components. This sets up an alias so that `@` can be used by the shadcn-vue CLI in the downloaded components. So `@` should point to where the shadcn-vue `components` and `lib` folders are located.

### `components.d.ts`

Auto-generated by `unplugin-vue-components`.

## Server

The most important part of the `server` setup are the `/` and `/api` endpoints. The `/` endpoint is not used during development. The Vue frontend is served by Vite during development and calls to `/api/*` endpoints are proxied to this Hono server.

But once the frontend is built for deployment, this Hono server will be the only server running, responsible for serving the frontend also. Vite builds the Vue project to the `/dist/client` folder. So Hono serves `index.html` and the associated `assets` and `public` resources fom there.

### `board.js`

This handles function calls to the `core` library. The `core` library handles state manipulations and database communications. The basic setup is that the server keeps an in-memory version of each board to rapidly update and broadcast changes. The database sync happens in the background. This keeps the database up to date but makes updates more rapid.

Both `board.js` and `stream.js` need to keep a list of each site, with that site's board and users. The `jwt` token used for authentication registers the user's site so updates can be applied appropriately. The `stream.js` clients list allows broadcasting updates to users by site.

### `stream.js`

This is the setup for the Server Sent Events that allow realtime updating of the app. The important piece of this code is the `keep-alive` message that is sent to each client every 15 seconds. Without this ping, the connection could be dropped. The Hono streamSSE helper also automatically closes any connection that does not have some sort of keep-alive mechanism to ensure the proper setup, though the documentation does not make this clear.

My research on SSE indicates this kind of setup can handle tens of thousands of users and thousands of broadcast updates per second. More than enough for our needs.
